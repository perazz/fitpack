<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fitpack: Scattered Surface Fitting Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeDarkModeToggle.init()
        </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">fitpack
   </div>
   <div id="projectbrief">Modern Fortran library for curve and surface fitting with splines</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorial_surface.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Scattered Surface Fitting Tutorial</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2fitpack_2fitpack_2doc_2tutorial__surface"></a></p>
<p>This tutorial covers bivariate spline fitting to scattered data with <code>fitpack_surface</code>: constructing a tensor-product B-spline \( z = s(x, y) \) from irregularly sampled \( (x_i, y_i, z_i) \) triples, controlling smoothness, and evaluating derived quantities.</p>
<p>Use <code>fitpack_surface</code> whenever your observations are not aligned on a rectangular grid. If the data <b>do</b> lie on a regular grid, prefer <code>fitpack_grid_surface</code> instead (see <a class="el" href="tutorial_grid_surface.html">Grid and Parametric Surface Tutorial</a>).</p>
<h1><a class="anchor" id="autotoc_md127"></a>
Mathematical Background</h1>
<p>Given \( m \) scattered observations \( (x_i, y_i, z_i) \) with positive weights \( w_i \), FITPACK determines a tensor-product B-spline</p>
<p class="formulaDsp">
\[    s(x, y) = \sum_{i=1}^{n_x - k_x - 1} \sum_{j=1}^{n_y - k_y - 1}
              c_{ij} \, B_i^{k_x}(x) \, B_j^{k_y}(y)
\]
</p>
<p>that minimizes the thin-plate smoothing energy subject to a residual constraint:</p>
<p class="formulaDsp">
\[    \sum_{i=1}^{m} \bigl( w_i \, (z_i - s(x_i, y_i)) \bigr)^2 \leq S
\]
</p>
<p>where \( S \) is the user-supplied smoothing parameter. Knot positions and the number of knots \( n_x, n_y \) are chosen automatically by the <code>surfit</code> algorithm.</p>
<p>The default spline degree is bicubic ( \( k_x = k_y = 3 \)). Degrees 1 through 5 are supported.</p>
<dl class="section see"><dt>See also</dt><dd>Dierckx, Ch. 5, &sect;5.3 (pp. 85&ndash;98)</dd></dl>
<h1><a class="anchor" id="autotoc_md128"></a>
Basic Example</h1>
<p>The code below fits a spline to 200 quasi-randomly distributed samples of \( f(x,y) = \sin(\pi x) \cos(\pi y) \) on \( [0,1]^2 \).</p>
<div class="fragment"><div class="line"><span class="keyword">program</span> surface_demo</div>
<div class="line">    <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacefitpack.html">fitpack</a>, <span class="keywordtype">only</span>: fitpack_surface, fp_real, fp_flag, &amp;</div>
<div class="line">                       fitpack_success, fitpack_message, zero, one, half, pi</div>
<div class="line">    <span class="keywordtype">implicit none</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: m = 200</div>
<div class="line"><span class="keywordtype">    real</span>(FP_REAL) :: x(m), y(m), z(m)</div>
<div class="line">    <span class="keywordtype">type</span>(fitpack_surface) :: surf</div>
<div class="line">    <span class="keywordtype">integer(FP_FLAG)</span> :: ierr</div>
<div class="line">    <span class="keywordtype">integer</span> :: i</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Quasi-random sampling (golden-ratio sequences)</span></div>
<div class="line">    <span class="keywordflow">do</span> i = 1, m</div>
<div class="line">        x(i) = mod(i * 0.6180339887_fp_real, one)</div>
<div class="line">        y(i) = mod(i * 0.3247179572_fp_real, one)</div>
<div class="line">        z(i) = sin(pi * x(i)) * cos(pi * y(i))</div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Fit with smoothing = m (a practical starting value for unit weights)</span></div>
<div class="line">    ierr = surf%new_fit(x, y, z, smoothing=real(m, fp_real))</div>
<div class="line">    <span class="keywordflow">if</span> (.not. fitpack_success(ierr)) error stop fitpack_message(ierr)</div>
<div class="line"> </div>
<div class="line">    print <span class="stringliteral">&#39;(a,i0,a,i0)&#39;</span>, <span class="stringliteral">&#39;Knots: &#39;</span>, surf%knots(1), <span class="stringliteral">&#39; x &#39;</span>, surf%knots(2)</div>
<div class="line">    print <span class="stringliteral">&#39;(a,es10.3)&#39;</span>,   <span class="stringliteral">&#39;Residual: &#39;</span>, surf%mse()</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">call </span>surf%destroy()</div>
<div class="line"><span class="keyword">end program</span></div>
<div class="ttc" id="anamespacefitpack_html"><div class="ttname"><a href="namespacefitpack.html">fitpack</a></div><div class="ttdoc">Umbrella module that re-exports the complete FITPACK public API.</div><div class="ttdef"><b>Definition</b> fitpack.f90:33</div></div>
</div><!-- fragment --><p><code>surf\new_fit(x, y, z, w, smoothing, order)</code> stores the data, allocates workspace, and performs a smoothing fit in a single call. It returns an <code>integer(FP_FLAG)</code> error code.</p>
<h1><a class="anchor" id="autotoc_md129"></a>
Features</h1>
<h2><a class="anchor" id="autotoc_md130"></a>
Point evaluation</h2>
<p>Evaluate the fitted surface at one or many scattered points:</p>
<div class="fragment"><div class="line"><span class="comment">! Scalar</span></div>
<div class="line">z_val = surf%eval(x_val, y_val, ierr)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! Array of scattered points</span></div>
<div class="line">z_arr = surf%eval(x_arr, y_arr, ierr)   ! <span class="keyword">size</span>(z_arr) == <span class="keyword">size</span>(x_arr)</div>
</div><!-- fragment --><p>Both <code>surf\eval</code> variants call the unscattered spline evaluator <code>bispeu</code>, so the input points need not be sorted.</p>
<h2><a class="anchor" id="autotoc_md131"></a>
Grid evaluation</h2>
<p>Evaluate on every node of a rectangular output grid:</p>
<div class="fragment"><div class="line"><span class="comment">! z_grid(j,i) = s(x_grid(i), y_grid(j))</span></div>
<div class="line">z_grid = surf%eval_ongrid(x_grid, y_grid, ierr)</div>
</div><!-- fragment --><p>The result has shape <code>(size(y_grid), size(x_grid))</code>.</p>
<h2><a class="anchor" id="autotoc_md132"></a>
Partial derivatives</h2>
<p>Compute \( \partial^{n_x+n_y} s / \partial x^{n_x} \partial y^{n_y} \) at scattered points or on a grid:</p>
<div class="fragment"><div class="line"><span class="comment">! ds/dx at a single point</span></div>
<div class="line">dzdx = surf%dfdx(x0, y0, 1, 0, ierr)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! d2s/dxdy at many scattered points</span></div>
<div class="line">d2 = surf%dfdx(x_arr, y_arr, 1, 1, ierr)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! ds/dy on a grid</span></div>
<div class="line">dz_grid = surf%dfdx_ongrid(x_grid, y_grid, 0, 1, ierr)</div>
</div><!-- fragment --><p>The derivative order arguments <code>nux</code>, <code>nuy</code> must satisfy \( 0 \leq n_x &lt; k_x \) and \( 0 \leq n_y &lt; k_y \).</p>
<h2><a class="anchor" id="autotoc_md133"></a>
Integration</h2>
<p>Integrate the surface over a rectangular sub-domain \( [x_1, x_2] \times [y_1, y_2] \):</p>
<div class="fragment"><div class="line">vol = surf%integral([x1, y1], [x2, y2])</div>
</div><!-- fragment --><p>The two arguments are 2-element arrays <code>lower = [x_lo, y_lo]</code> and <code>upper = [x_hi, y_hi]</code>.</p>
<h2><a class="anchor" id="autotoc_md134"></a>
Cross-sections</h2>
<p>Extract a one-dimensional profile by fixing one coordinate:</p>
<div class="fragment"><div class="line"><span class="keywordtype">type</span>(fitpack_curve) :: profile</div>
<div class="line"> </div>
<div class="line"><span class="comment">! Profile f(y) = s(x0, y)  (along_y = .true.)</span></div>
<div class="line">profile = surf%cross_section(x0, .true., ierr)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! Profile g(x) = s(x, y0)  (along_y = .false.)</span></div>
<div class="line">profile = surf%cross_section(y0, .false., ierr)</div>
</div><!-- fragment --><p>The returned <code>fitpack_curve</code> is a full 1D spline that can be evaluated, differentiated, and integrated independently.</p>
<h2><a class="anchor" id="autotoc_md135"></a>
Derivative spline</h2>
<p>Build a new <code>fitpack_surface</code> whose evaluation gives a partial derivative of the original:</p>
<div class="fragment"><div class="line"><span class="keywordtype">type</span>(fitpack_surface) :: dsdx_surf</div>
<div class="line"> </div>
<div class="line">dsdx_surf = surf%derivative_spline(1, 0, ierr)   ! ds/dx</div>
</div><!-- fragment --><p>The resulting surface has reduced degree \( (k_x - n_x, \; k_y - n_y) \).</p>
<h1><a class="anchor" id="autotoc_md136"></a>
Smoothing Sweep</h1>
<p>The smoothing parameter \( S \) controls the trade-off between fidelity and smoothness. Smaller \( S \) forces more knots and a closer fit; larger \( S \) yields a smoother approximation.</p>
<div class="fragment"><div class="line">print <span class="stringliteral">&#39;(a)&#39;</span>, <span class="stringliteral">&#39;     S       knots_x  knots_y  residual&#39;</span></div>
<div class="line"><span class="keywordflow">do</span> i = 1, 4</div>
<div class="line">    ierr = surf%new_fit(x, y, z, smoothing=10.0_fp_real**(3 - i))</div>
<div class="line">    <span class="keywordflow">if</span> (fitpack_success(ierr)) <span class="keywordflow">then</span></div>
<div class="line">        print <span class="stringliteral">&#39;(es10.1, 2i9, es12.3)&#39;</span>, &amp;</div>
<div class="line">              surf%smoothing, surf%knots(1), surf%knots(2), surf%mse()</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"><span class="keyword">end </span>do</div>
</div><!-- fragment --><p>Special cases:</p>
<ul>
<li>** \( S = 0 \)** &mdash; interpolation (the spline passes through every data point). Use <code>surf\interpolate()</code>.</li>
<li>**Large \( S \)** &mdash; very smooth, few knots, possibly large residual.</li>
<li>** \( S = m \)** (number of data points, unit weights) &mdash; a practical starting value.</li>
</ul>
<p>After any fit, <code>surf\mse()</code> returns the weighted sum of squared residuals \( f_p \), and <code>surf\knots</code> returns a 2-element integer array \( [n_x, n_y] \).</p>
<h1><a class="anchor" id="autotoc_md137"></a>
Fitting Modes</h1>
<p>The same three strategies available for curves work for surfaces:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Method   </th><th class="markdownTableHeadNone">Call   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Automatic knots   </td><td class="markdownTableBodyNone"><code>surf\fit(smoothing=s)</code>   </td><td class="markdownTableBodyNone">Knots chosen to satisfy the smoothing constraint    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Interpolation   </td><td class="markdownTableBodyNone"><code>surf\interpolate()</code>   </td><td class="markdownTableBodyNone">Passes through all data points ( \( S = 0 \))    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Least-squares   </td><td class="markdownTableBodyNone"><code>surf\least_squares()</code>   </td><td class="markdownTableBodyNone">User-supplied knots, no smoothing constraint   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md138"></a>
Error Handling</h1>
<p>All routines return an <code>integer(FP_FLAG)</code> error code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacefitpack.html">fitpack</a>, <span class="keywordtype">only</span>: fitpack_ok, fitpack_success, fitpack_message</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (.not. fitpack_success(ierr)) <span class="keywordflow">then</span></div>
<div class="line">    print *, <span class="stringliteral">&#39;Error: &#39;</span>, fitpack_message(ierr)</div>
<div class="line"><span class="keyword">end </span>if</div>
</div><!-- fragment --><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag   </th><th class="markdownTableHeadNone">Meaning    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_OK</code> (0)   </td><td class="markdownTableBodyNone">Success    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FITPACK_INTERPOLATING_OK</code> (-1)   </td><td class="markdownTableBodyNone">Interpolating spline returned    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_S_TOO_SMALL</code> (1)   </td><td class="markdownTableBodyNone">Smoothing too small for the knot budget    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FITPACK_MAXIT</code> (2)   </td><td class="markdownTableBodyNone">Maximum iterations reached    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_INPUT_ERROR</code> (10)   </td><td class="markdownTableBodyNone">Invalid input data   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md139"></a>
Complete Example</h1>
<p>A self-contained program demonstrating all of the features above is provided in <code>examples/example_surface.f90</code>. Build and run it with:</p>
<div class="fragment"><div class="line">fpm run --example example_surface</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
