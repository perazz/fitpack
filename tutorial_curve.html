<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fitpack: Univariate Curve Fitting with fitpack_curve</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeDarkModeToggle.init()
        </script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">fitpack
   </div>
   <div id="projectbrief">Modern Fortran library for curve and surface fitting with splines</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('tutorial_curve.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Univariate Curve Fitting with fitpack_curve</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2fitpack_2fitpack_2doc_2tutorial__curve"></a></p>
<p>This tutorial explains how to use the <code>fitpack_curve</code> type for univariate spline smoothing and interpolation of the form \( y = s(x) \). It covers the mathematical background, basic and advanced usage, and practical guidance on choosing a smoothing parameter.</p>
<p>Use <code>fitpack_curve</code> when you have a single-valued relationship between an independent variable \( x \) and a dependent variable \( y \) &mdash; that is, each \( x_i \) maps to exactly one \( y_i \). The data must be sorted in strictly increasing order of \( x \).</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Mathematical Background</h1>
<p>Given \( m \) data points \( (x_i, y_i) \) with positive weights \( w_i \), FITPACK constructs a B-spline \( s(x) \) of degree \( k \) (default \( k = 3 \), cubic) by solving the constrained optimization problem</p>
<p class="formulaDsp">
\[    \min \int_{x_1}^{x_m} \left[ s&#39;&#39;(x) \right]^2 dx
    \quad \text{subject to} \quad
    \sum_{i=1}^{m} w_i^2 \left( y_i - s(x_i) \right)^2 \leq S
\]
</p>
<p>The <b>smoothing parameter</b> \( S \geq 0 \) controls the trade-off between roughness and fidelity to the data:</p>
<ul>
<li>** \( S = 0 \)** &mdash; Interpolation. The spline passes through every data point exactly.</li>
<li>**Small \( S \)** &mdash; Close to the data but may oscillate between points.</li>
<li>**Large \( S \)** &mdash; Very smooth, but may miss genuine features.</li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
Choosing S</h2>
<p>When the data satisfy \( y_i = g(x_i) + \varepsilon_i \) with independent errors of variance \( \sigma^2 \) and unit weights, the expected residual sum of squares for the true function is \( m \sigma^2 \). A natural starting point is therefore</p>
<p class="formulaDsp">
\[    S \approx m \, \sigma^2
\]
</p>
<p>If no noise estimate is available, \( S = m \) (assuming unit weights) is a reasonable first guess. The algorithm selects knots automatically: fewer knots for larger \( S \), more knots for smaller \( S \). After fitting, inspect <code>curve\mse()</code> and <code>curve\knots</code> to judge the result.</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Basic Example</h1>
<p>The following program fits a smoothing spline to noisy sine data, evaluates it, and prints the result.</p>
<div class="fragment"><div class="line"><span class="keyword">program</span> basic_curve</div>
<div class="line">    <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacefitpack.html">fitpack</a>, <span class="keywordtype">only</span>: fitpack_curve, fp_real, fp_flag, &amp;</div>
<div class="line">                       fitpack_success, fitpack_message, &amp;</div>
<div class="line">                       zero, one, half, pi</div>
<div class="line">    <span class="keywordtype">implicit none</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: m = 50</div>
<div class="line"><span class="keywordtype">    real</span>(FP_REAL), <span class="keywordtype">parameter</span> :: two = 2.0_fp_real</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">    real</span>(FP_REAL) :: x(m), y(m), dx</div>
<div class="line">    <span class="keywordtype">type</span>(fitpack_curve) :: curve</div>
<div class="line">    <span class="keywordtype">integer(FP_FLAG)</span> :: ierr</div>
<div class="line"><span class="keywordtype">    real</span>(FP_REAL) :: y_at_pi</div>
<div class="line">    <span class="keywordtype">integer</span> :: i</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Generate data on [0, 2*pi]</span></div>
<div class="line">    dx = two * pi / (m - 1)</div>
<div class="line">    <span class="keywordflow">do</span> i = 1, m</div>
<div class="line">        x(i) = (i - 1) * dx</div>
<div class="line">        y(i) = sin(x(i)) + 0.05_fp_real * sin(17.0_fp_real * x(i))</div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Fit a smoothing spline (S = m)</span></div>
<div class="line">    ierr = curve%new_fit(x, y, smoothing=real(m, fp_real))</div>
<div class="line">    <span class="keywordflow">if</span> (.not. fitpack_success(ierr)) <span class="keywordflow">then</span></div>
<div class="line">        print *, <span class="stringliteral">&#39;Fit failed: &#39;</span>, fitpack_message(ierr)</div>
<div class="line">        error stop</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Evaluate at x = pi</span></div>
<div class="line">    y_at_pi = curve%eval(pi, ierr)</div>
<div class="line">    print <span class="stringliteral">&#39;(a,f10.6)&#39;</span>, <span class="stringliteral">&#39;s(pi)  = &#39;</span>, y_at_pi</div>
<div class="line">    print <span class="stringliteral">&#39;(a,i0)&#39;</span>,    <span class="stringliteral">&#39;knots  = &#39;</span>, curve%knots</div>
<div class="line">    print <span class="stringliteral">&#39;(a,es10.3)&#39;</span>, <span class="stringliteral">&#39;mse    = &#39;</span>, curve%mse()</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">call </span>curve%destroy()</div>
<div class="line"><span class="keyword">end program </span>basic_curve</div>
<div class="ttc" id="anamespacefitpack_html"><div class="ttname"><a href="namespacefitpack.html">fitpack</a></div><div class="ttdoc">Umbrella module that re-exports the complete FITPACK public API.</div><div class="ttdef"><b>Definition</b> fitpack.f90:33</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md22"></a>
Step-by-step</h2>
<ol type="1">
<li><b>Import</b> &sect; The <code>use fitpack</code> statement exposes the curve type, kind parameters (<code>FP_REAL</code>, <code>FP_FLAG</code>), error-handling helpers (<code>FITPACK_SUCCESS</code>, <code>FITPACK_MESSAGE</code>), and named constants (<code>zero</code>, <code>one</code>, <code>half</code>, <code>pi</code>). Note that <code>two</code> is not a public export &mdash; define it locally when needed.</li>
<li><b>Prepare data</b> &sect; The abscissae <code>x</code> must be strictly increasing. The corresponding values <code>y</code> may contain noise.</li>
<li><b>Fit</b> &sect; <code>curve\new_fit(x, y, smoothing=S)</code> constructs the spline. It returns an <code>integer(FP_FLAG)</code> error code. Check it with <code>FITPACK_SUCCESS(ierr)</code>.</li>
<li><b>Evaluate</b> &sect; <code>curve\eval(x, ierr)</code> accepts a scalar or an array and returns the spline value(s).</li>
<li><b>Clean up</b> &sect; <code>curve\destroy()</code> releases all internal allocations.</li>
</ol>
<h1><a class="anchor" id="autotoc_md23"></a>
Advanced Features</h1>
<h2><a class="anchor" id="autotoc_md24"></a>
Weights</h2>
<p>Supply per-point weights via the <code>w</code> argument to emphasize or de-emphasize individual observations. Points with larger weights are fitted more closely.</p>
<div class="fragment"><div class="line"><span class="keywordtype">real</span>(FP_REAL) :: w(m)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! Inverse-variance weighting</span></div>
<div class="line">w = one / sigma</div>
<div class="line">ierr = curve%new_fit(x, y, w=w, smoothing=real(m, fp_real))</div>
</div><!-- fragment --><p>When weights are proportional to \( 1 / \sigma_i \), the smoothing constraint becomes \( \sum (y_i - s(x_i))^2 / \sigma_i^2 \leq S \), and \( S \approx m \) remains a natural choice.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Derivatives</h2>
<p>Evaluate derivatives of the fitted spline up to order \( k \) (the spline degree, default 3):</p>
<div class="fragment"><div class="line"><span class="keywordtype">real</span>(FP_REAL) :: dydx, d2ydx2</div>
<div class="line"> </div>
<div class="line">dydx   = curve%dfdx(pi / 4, order=1, ierr=ierr)   <span class="comment">! first derivative</span></div>
<div class="line">d2ydx2 = curve%dfdx(pi / 4, order=2, ierr=ierr)   ! second derivative</div>
</div><!-- fragment --><p>The <code>order</code> parameter selects which derivative: 1 for \( s&#39;(x) \), 2 for \( s&#39;&#39;(x) \), 3 for \( s&#39;&#39;&#39;(x) \).</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Integration</h2>
<p>Compute the definite integral of the spline over an arbitrary sub-interval \( [a, b] \):</p>
<div class="fragment"><div class="line"><span class="keywordtype">real</span>(FP_REAL) :: area</div>
<div class="line"> </div>
<div class="line">area = curve%integral(zero, pi)</div>
</div><!-- fragment --><p>This evaluates \( \int_a^b s(x) \, dx \) analytically from the B-spline coefficients, so the result is exact for the fitted spline (no numerical quadrature error).</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Zero Finding</h2>
<p>Find all zeros (roots) of a cubic spline within the data range:</p>
<div class="fragment"><div class="line"><span class="keywordtype">real</span>(FP_REAL), <span class="keywordtype">allocatable</span> :: roots(:)</div>
<div class="line"> </div>
<div class="line">roots = curve%zeros(ierr)</div>
<div class="line">print <span class="stringliteral">&#39;(a,i0)&#39;</span>, <span class="stringliteral">&#39;Number of zeros: &#39;</span>, <span class="keyword">size</span>(roots)</div>
</div><!-- fragment --><p>The <code>curve\zeros(ierr)</code> function returns an allocatable array containing every root of \( s(x) = 0 \). This operation requires a cubic spline ( \( k = 3 \)).</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Interpolation</h2>
<p>For exact interpolation &mdash; a spline that passes through every data point &mdash; set <code>smoothing=zero</code>:</p>
<div class="fragment"><div class="line">ierr = curve%new_fit(x, y, smoothing=zero)</div>
</div><!-- fragment --><p>Alternatively, call the dedicated interpolation method:</p>
<div class="fragment"><div class="line">ierr = curve%interpolate()</div>
</div><!-- fragment --><p>Both produce the smoothest spline (minimum roughness integral) that satisfies \( s(x_i) = y_i \) for all \( i \).</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Smoothing Sweep</h2>
<p>When the appropriate smoothing level is unknown, try a sequence of \( S \) values on a logarithmic scale and inspect the resulting number of knots and residual:</p>
<div class="fragment"><div class="line"><span class="keywordtype">integer</span> :: j</div>
<div class="line"> </div>
<div class="line">print <span class="stringliteral">&#39;(a)&#39;</span>, <span class="stringliteral">&#39;     S       knots   residual&#39;</span></div>
<div class="line"><span class="keywordflow">do</span> j = 1, 5</div>
<div class="line">    ierr = curve%new_fit(x, y, smoothing=10.0_fp_real**(3 - j))</div>
<div class="line">    <span class="keywordflow">if</span> (fitpack_success(ierr)) <span class="keywordflow">then</span></div>
<div class="line">        print <span class="stringliteral">&#39;(es10.1,i8,es12.3)&#39;</span>, &amp;</div>
<div class="line">            curve%smoothing, curve%knots, curve%mse()</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"><span class="keyword">end </span>do</div>
</div><!-- fragment --><p>A good fit typically shows a "knee" where adding more knots (decreasing \( S \)) yields diminishing improvement in the residual. Choose the \( S \) value at or just past this transition point.</p>
<h1><a class="anchor" id="autotoc_md30"></a>
API Summary</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Method   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>curve\new_fit(x, y, w, smoothing, order)</code>   </td><td class="markdownTableBodyNone">Fit a smoothing spline; returns <code>integer(FP_FLAG)</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>curve\eval(x, ierr)</code>   </td><td class="markdownTableBodyNone">Evaluate \( s(x) \) at a scalar or array of points    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>curve\dfdx(x, order, ierr)</code>   </td><td class="markdownTableBodyNone">Evaluate derivative of order 1, 2, or 3    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>curve\integral(from, to)</code>   </td><td class="markdownTableBodyNone">Definite integral \( \int_a^b s(x) \, dx \)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>curve\zeros(ierr)</code>   </td><td class="markdownTableBodyNone">All zeros of \( s(x) \) (cubic splines only)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>curve\interpolate()</code>   </td><td class="markdownTableBodyNone">Exact interpolation ( \( S = 0 \))    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>curve\knots</code>   </td><td class="markdownTableBodyNone">Number of knots in the current fit    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>curve\mse()</code>   </td><td class="markdownTableBodyNone">Weighted residual sum of squares \( f_p \)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>curve\smoothing</code>   </td><td class="markdownTableBodyNone">Current smoothing parameter \( S \)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>curve\destroy()</code>   </td><td class="markdownTableBodyNone">Release all allocated memory   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md31"></a>
Complete Example</h1>
<p>A fully compilable program demonstrating smoothing, interpolation, derivatives, integration, root finding, and a smoothing sweep is provided in <code>examples/example_curve.f90</code>. Build and run it with:</p>
<div class="fragment"><div class="line">fpm run --example example_curve</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md32"></a>
Error Handling</h1>
<p>All fitting and evaluation routines return an <code>integer(FP_FLAG)</code> error code. Use <code>FITPACK_SUCCESS(ierr)</code> to test for success and <code>FITPACK_MESSAGE(ierr)</code> to obtain a human-readable description:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (.not. fitpack_success(ierr)) <span class="keywordflow">then</span></div>
<div class="line">    print *, <span class="stringliteral">&#39;Error: &#39;</span>, fitpack_message(ierr)</div>
<div class="line"><span class="keyword">end </span>if</div>
</div><!-- fragment --><p>Common return values:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag   </th><th class="markdownTableHeadNone">Meaning    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_OK</code> (0)   </td><td class="markdownTableBodyNone">Success    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FITPACK_INTERPOLATING_OK</code> ( \(-1\))   </td><td class="markdownTableBodyNone">Interpolating spline returned    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_S_TOO_SMALL</code> (1)   </td><td class="markdownTableBodyNone">Smoothing parameter too small for the knot budget    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FITPACK_MAXIT</code> (2)   </td><td class="markdownTableBodyNone">Maximum iterations reached    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FITPACK_INPUT_ERROR</code> (10)   </td><td class="markdownTableBodyNone">Invalid input data   </td></tr>
</table>
<dl class="section see"><dt>See also</dt><dd>theory_curve_fitting </dd>
<dd>
theory_bsplines </dd>
<dd>
<a class="el" href="tutorial_periodic_curve.html">Periodic Curve Fitting</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
